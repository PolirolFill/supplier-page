<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прототип сервиса для медицинского учреждения (v3.0 Full)</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header {
            border-bottom: 1px solid #dee2e6;
        }
        .logo {
            font-weight: bold;
            font-size: 1.5rem;
            color: #0d6efd;
        }
        .table th {
            cursor: pointer;
            user-select: none;
        }
        .table th:hover {
            background-color: #e9ecef;
        }
        .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-icon.active {
            opacity: 1;
        }
        .nav-link.active {
            font-weight: bold;
            color: #0d6efd !important;
            border-bottom: 2px solid #0d6efd;
        }
        .form-signin {
            max-width: 400px;
            padding: 1rem;
        }
        .breadcrumb-container {
            background-color: #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
        }
        .breadcrumb-item a {
            text-decoration: none;
        }
        .widget {
            height: 100%;
        }
        .toast-container {
            z-index: 1100; /* Higher than modals */
        }
    </style>
</head>
<body>

    <header class="bg-light p-3 header sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="#" class="logo text-decoration-none">Логотип клиники</a>
            <div id="nav-container"></div>
        </div>
    </header>

    <main class="container mt-4 pb-5">
        <div id="breadcrumb-container" class="mb-3"></div>
        <div id="app-root">
            <!-- Application content will be rendered here -->
        </div>
    </main>

    <!-- Toast Container for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Application Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // ========================================================================
        // 1. MOCK DATA & DATABASE LAYER (using localStorage)
        // ========================================================================
        const DB = {
            init: () => {
                const initIfNeeded = (key, dataFactory) => {
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, JSON.stringify(dataFactory()));
                    }
                };

                initIfNeeded('needs', () => [
                    { id: 1, type: "Медикаменты", name: "Бинты медицинские", description: "Стерильные, 5x10 см", code: "21.20.24.131", unit: "упаковка", quantity: 100, deliveryDate: "2025-10-01", status: "Запрос КП" },
                    { id: 2, type: "Оборудование", name: "Шприцы одноразовые", description: "5 мл, с иглой", code: "32.50.13.110", unit: "шт", quantity: 500, deliveryDate: "2025-09-30", status: "Малая закупка" },
                    { id: 3, type: "Медикаменты", name: "Антисептик кожный", description: "Спиртовой, 1л", code: "20.20.14.000", unit: "флакон", quantity: 50, deliveryDate: "2025-08-15", status: "Аукцион" },
                    { id: 4, type: "Расходные материалы", name: "Перчатки нитриловые", description: "Размер M, 100 шт/уп", code: "22.19.60.114", unit: "упаковка", quantity: 200, deliveryDate: "2025-09-01", status: "Запрос КП" },
                    { id: 5, type: "Оборудование", name: "Тонометр автоматический", description: "На плечо, с адаптером", code: "32.50.13.190", unit: "шт", quantity: 10, deliveryDate: "2025-11-20", status: "Малая закупка" },
                    { id: 6, type: "Медикаменты", name: "Парацетамол таблетки", description: "500 мг, №20", code: "21.20.10.235", unit: "упаковка", quantity: 300, deliveryDate: "2025-08-25", status: "Запрос КП" },
                    { id: 7, type: "Расходные материалы", name: "Маски медицинские", description: "Трехслойные, 50 шт/уп", code: "32.50.50.190", unit: "упаковка", quantity: 1000, deliveryDate: "2025-07-30", status: "Аукцион" },
                ]);

                initIfNeeded('users', () => [
                    { id: 1, login: "supplier1", email: "supplier1@example.com", password: "pass123", ip: "192.168.1.10", hostname: "host1.example.com", status: "active" },
                    { id: 2, login: "bestmed", email: "contact@bestmed.com", password: "pass123", ip: "203.0.113.45", hostname: "mail.bestmed.com", status: "active" },
                    { id: 3, login: "farm-postavka", email: "info@farm-postavka.ru", password: "pass123", ip: "198.51.100.12", hostname: "server.farm-postavka.ru", status: "blocked" },
                    { id: 4, login: "techsnab", email: "manager@techsnab.org", password: "pass123", ip: "8.8.8.8", hostname: "google-public-dns-a.google.com", status: "active" },
                ]);

                initIfNeeded('admin', () => ({ login: "admin", password: "admin123" }));
                
                initIfNeeded('proposals', () => [
                    { userId: 1, needId: 2 },
                    { userId: 2, needId: 4 },
                    { userId: 4, needId: 1 },
                    { userId: 4, needId: 5 },
                ]);

                initIfNeeded('notificationTemplates', () => [
                    { id: 1, name: "Подтверждение регистрации", event: "user_registered", subject: "Добро пожаловать!", body: "Уважаемый {{user.login}},\n\nВы успешно зарегистрировались на нашем портале." },
                    { id: 2, name: "Изменение статуса потребности", event: "need_status_changed", subject: "Изменение статуса по позиции {{need.name}}", body: "Статус потребности {{need.name}} (код {{need.code}}) был изменен на '{{need.status}}'." },
                    { id: 3, name: "Общая рассылка", event: "manual", subject: "Важная информация для поставщиков", body: "Уважаемые партнеры, просим обратить внимание на следующие изменения..." }
                ]);

                initIfNeeded('notificationLog', () => []);
                initIfNeeded('savedViews', () => ({ needs: [], users: [] }));
                initIfNeeded('adminDashboardSettings', () => ({ widgets: ['quickStats', 'latestActivity'] }));
            },
            get: (key) => JSON.parse(localStorage.getItem(key)),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            getNextId: (key) => {
                const items = DB.get(key) || [];
                return items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
            }
        };

        // ========================================================================
        // 2. AUTHENTICATION LAYER
        // ========================================================================
        const Auth = {
            login: (userType, token) => localStorage.setItem(`${userType}Token`, token),
            logout: () => {
                localStorage.removeItem('supplierToken');
                localStorage.removeItem('adminToken');
                window.location.hash = '/';
            },
            isLoggedIn: (userType) => !!localStorage.getItem(`${userType}Token`),
            getCurrentUser: () => {
                const token = localStorage.getItem('supplierToken');
                if (!token) return null;
                try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
            }
        };

        // ========================================================================
        // 3. APPLICATION STATE & STATE MANAGEMENT
        // ========================================================================
        const State = {
            needs: { filters: { type: '', status: '', search: '', submitted_by_user_id: null }, sort: { column: 'id', direction: 'asc' }, currentPage: 1, itemsPerPage: 10 },
            users: { filters: { status: '', search: '' }, sort: { column: 'id', direction: 'asc' }, currentPage: 1, itemsPerPage: 10 },
            
            saveListState: (key) => sessionStorage.setItem(`${key}ListState`, JSON.stringify(State[key])),
            loadListState: (key) => {
                const savedState = sessionStorage.getItem(`${key}ListState`);
                if (savedState) {
                    State[key] = JSON.parse(savedState);
                    return true;
                }
                return false;
            },
            resetListState: (key) => {
                sessionStorage.removeItem(`${key}ListState`);
                if (key === 'needs') State.needs = { filters: { type: '', status: '', search: '', submitted_by_user_id: null }, sort: { column: 'id', direction: 'asc' }, currentPage: 1, itemsPerPage: 10 };
                if (key === 'users') State.users = { filters: { status: '', search: '' }, sort: { column: 'id', direction: 'asc' }, currentPage: 1, itemsPerPage: 10 };
            }
        };

        // ========================================================================
        // 4. UTILS & HELPERS
        // ========================================================================
        const Utils = {
            getIpInfo: async () => {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    console.log('IP Info:', { ip: data.ip, hostname: data.hostname || 'N/A' });
                    return { ip: data.ip, hostname: data.hostname || 'N/A' };
                } catch (error) {
                    console.error('Failed to fetch IP info:', error);
                    return { ip: 'N/A', hostname: 'N/A' };
                }
            },
            showModal: (title, body, footer = '', size = '') => {
                const existingModal = document.getElementById('appModal');
                if (existingModal) existingModal.remove();
                
                const modalHTML = `
                    <div class="modal fade" id="appModal" tabindex="-1">
                        <div class="modal-dialog ${size} modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${body}</div>
                                ${footer ? `<div class="modal-footer">${footer}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modalEl = document.getElementById('appModal');
                const modal = new bootstrap.Modal(modalEl);
                modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
                modal.show();
                return modal;
            },
            showToast: (message, type = 'success') => {
                const toastId = `toast-${Date.now()}`;
                const toastIcon = type === 'success' ? '<i class="bi bi-check-circle-fill text-success me-2"></i>' : '<i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>';
                const toastHTML = `
                    <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${toastIcon} ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML);
                const toastEl = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastEl);
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
                toast.show();
            },
            renderSortIcon: (columnName, stateObject) => {
                if (stateObject.sort.column === columnName) {
                    return `<span class="sort-icon active">${stateObject.sort.direction === 'asc' ? '▲' : '▼'}</span>`;
                }
                return `<span class="sort-icon">▲</span>`;
            },
            applySorting: (data, sort) => {
                return [...data].sort((a, b) => {
                    const valA = a[sort.column]; const valB = b[sort.column];
                    if (valA < valB) return sort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            },
            parseHash: () => {
                const [hash, query] = window.location.hash.substring(1).split('?');
                const pathParts = hash.split('/').filter(p => p);
                const queryParams = new URLSearchParams(query);
                return { pathParts, queryParams };
            },
            renderBreadcrumbs: (items) => {
                const container = document.getElementById('breadcrumb-container');
                if (!items || items.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                const breadcrumbHtml = `
                    <nav aria-label="breadcrumb" class="breadcrumb-container">
                        <ol class="breadcrumb mb-0">
                            ${items.map((item, index) => `
                                <li class="breadcrumb-item ${index === items.length - 1 ? 'active' : ''}" ${index === items.length - 1 ? 'aria-current="page"' : ''}>
                                    ${item.link ? `<a href="${item.link}">${item.name}</a>` : item.name}
                                </li>
                            `).join('')}
                        </ol>
                    </nav>
                `;
                container.innerHTML = breadcrumbHtml;
            },
            formatDate: (dateString) => new Date(dateString).toLocaleString('ru-RU'),
            renderPagination: (currentPage, totalPages, stateKey) => {
                if (totalPages <= 1) return '';
                let paginationHTML = '<ul class="pagination justify-content-center">';
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `
                        <li class="page-item ${currentPage === i ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}" data-state-key="${stateKey}">${i}</a>
                        </li>
                    `;
                }
                paginationHTML += '</ul>';
                return paginationHTML;
            }
        };

        // ========================================================================
        // 5. VIEW RENDERING LAYER
        // ========================================================================
        const Views = {
            // --- Common ---
            renderHeader: () => {
                const navContainer = document.getElementById('nav-container');
                const { pathParts } = Utils.parseHash();
                const currentRoot = pathParts[0] || '';
                const currentPage = pathParts[1] || 'dashboard';

                if (Auth.isLoggedIn('admin')) {
                    navContainer.innerHTML = `
                        <ul class="nav nav-pills">
                            <li class="nav-item"><a href="#/admin/dashboard" class="nav-link ${currentPage === 'dashboard' ? 'active' : ''}">Панель</a></li>
                            <li class="nav-item"><a href="#/admin/needs" class="nav-link ${currentPage === 'needs' ? 'active' : ''}">Потребности</a></li>
                            <li class="nav-item"><a href="#/admin/users" class="nav-link ${currentPage === 'users' ? 'active' : ''}">Пользователи</a></li>
                            <li class="nav-item"><a href="#/admin/statistics" class="nav-link ${currentPage === 'statistics' ? 'active' : ''}">Статистика</a></li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle ${['templates', 'log'].includes(currentPage) ? 'active' : ''}" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Уведомления</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#/admin/templates">Шаблоны</a></li>
                                    <li><a class="dropdown-item" href="#/admin/log">Лог отправки</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><button class="btn btn-outline-primary ms-3" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Выйти</button></li>
                        </ul>
                    `;
                } else if (Auth.isLoggedIn('supplier')) {
                    navContainer.innerHTML = `<button class="btn btn-outline-primary" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Выйти</button>`;
                } else {
                    navContainer.innerHTML = `<a href="#/admin-login" class="btn btn-sm btn-outline-secondary">Вход для администратора</a>`;
                }
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.addEventListener('click', Auth.logout);
            },

            // --- Supplier Views ---
            renderSupplierRegister: () => {
                Utils.renderBreadcrumbs([]);
                const appRoot = document.getElementById('app-root');
                appRoot.innerHTML = `
                    <div class="row justify-content-center">
                        <div class="col-md-6 col-lg-5">
                            <div class="card shadow-sm">
                                <div class="card-body p-4">
                                    <h1 class="card-title text-center mb-4">Регистрация поставщика</h1>
                                    <form id="registerForm">
                                        <input type="hidden" id="ip-info" name="ip-info">
                                        <div class="mb-3"><label for="login" class="form-label">Логин</label><input type="text" id="login" class="form-control" required></div>
                                        <div class="mb-3"><label for="email" class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
                                        <div class="mb-3"><label for="confirmEmail" class="form-label">Подтвердите email</label><input type="email" id="confirmEmail" class="form-control" required><div class="invalid-feedback">Адреса email не совпадают.</div></div>
                                        <div class="mb-3"><label for="password" class="form-label">Пароль</label><input type="password" id="password" class="form-control" required></div>
                                        <button type="submit" class="btn btn-primary w-100">Зарегистрироваться</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                Utils.getIpInfo().then(info => { document.getElementById('ip-info').value = JSON.stringify(info); });

                document.getElementById('registerForm').addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    const login = form.querySelector('#login').value, email = form.querySelector('#email').value, confirmEmail = form.querySelector('#confirmEmail').value, password = form.querySelector('#password').value, ipInfo = JSON.parse(form.querySelector('#ip-info').value);

                    if (email !== confirmEmail) { form.querySelector('#confirmEmail').classList.add('is-invalid'); return; }
                    form.querySelector('#confirmEmail').classList.remove('is-invalid');

                    const users = DB.get('users');
                    const newUser = { id: DB.getNextId('users'), login, email, password, ip: ipInfo.ip, hostname: ipInfo.hostname, status: 'active' };
                    users.push(newUser);
                    DB.set('users', users);

                    const mockToken = `mock-header.${btoa(JSON.stringify({id: newUser.id, login: newUser.login}))}.mock-signature`;
                    Auth.login('supplier', mockToken);
                    
                    App.triggerEvent('user_registered', { user: newUser });
                    Utils.showModal('Регистрация успешна', `Подтверждение отправлено на email: <strong>${email}</strong>`);
                    
                    window.location.hash = '/';
                });
            },

            renderSupplierNeeds: () => {
                Utils.renderBreadcrumbs([{ name: 'Потребности учреждения' }]);
                const appRoot = document.getElementById('app-root');
                const needs = DB.get('needs');
                const proposals = DB.get('proposals');
                const currentUser = Auth.getCurrentUser();
                const userProposals = proposals.filter(p => p.userId === currentUser.id).map(p => p.needId);

                let filteredNeeds = needs.filter(need => {
                    const typeMatch = State.needs.filters.type ? need.type === State.needs.filters.type : true;
                    const statusMatch = State.needs.filters.status ? need.status === State.needs.filters.status : true;
                    const searchMatch = State.needs.filters.search ? (need.name.toLowerCase().includes(State.needs.filters.search.toLowerCase()) || need.code.toLowerCase().includes(State.needs.filters.search.toLowerCase())) : true;
                    return typeMatch && statusMatch && searchMatch;
                });

                filteredNeeds = Utils.applySorting(filteredNeeds, State.needs.sort);
                const totalPages = Math.ceil(filteredNeeds.length / State.needs.itemsPerPage);
                const paginatedNeeds = filteredNeeds.slice((State.needs.currentPage - 1) * State.needs.itemsPerPage, State.needs.currentPage * State.needs.itemsPerPage);
                const uniqueTypes = [...new Set(DB.get('needs').map(n => n.type))];
                const uniqueStatuses = [...new Set(DB.get('needs').map(n => n.status))];

                appRoot.innerHTML = `
                    <div class="card">
                        <div class="card-header"><h3>Потребности учреждения</h3></div>
                        <div class="card-body">
                            <div class="row g-3 mb-3 align-items-center">
                                <div class="col-md-3"><select class="form-select" id="typeFilter"><option value="">Все типы</option>${uniqueTypes.map(t => `<option value="${t}" ${State.needs.filters.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                                <div class="col-md-3"><select class="form-select" id="statusFilter"><option value="">Все статусы</option>${uniqueStatuses.map(s => `<option value="${s}" ${State.needs.filters.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                                <div class="col-md-6"><input type="text" class="form-control" id="search" placeholder="Поиск по наименованию или коду..." value="${State.needs.filters.search}"></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th data-sort="type">Тип ${Utils.renderSortIcon('type', State.needs)}</th>
                                            <th data-sort="name">Наименование ${Utils.renderSortIcon('name', State.needs)}</th>
                                            <th>Характеристики</th>
                                            <th data-sort="code">Код ${Utils.renderSortIcon('code', State.needs)}</th>
                                            <th data-sort="quantity">Кол-во ${Utils.renderSortIcon('quantity', State.needs)}</th>
                                            <th data-sort="deliveryDate">Срок ${Utils.renderSortIcon('deliveryDate', State.needs)}</th>
                                            <th data-sort="status">Статус ${Utils.renderSortIcon('status', State.needs)}</th>
                                            <th>Действие</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${paginatedNeeds.map(need => `
                                            <tr>
                                                <td>${need.type}</td><td>${need.name}</td><td>${need.description}</td><td>${need.code}</td>
                                                <td>${need.quantity} ${need.unit}</td><td>${need.deliveryDate}</td><td>${need.status}</td>
                                                <td class="action-cell" data-need-id="${need.id}">
                                                    ${userProposals.includes(need.id) ? `
                                                        <span class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> В перечне</span>
                                                        <button class="btn btn-sm btn-secondary ms-2 undo-proposal-btn" data-id="${need.id}">Отменить</button>
                                                    ` : `
                                                        <button class="btn btn-sm btn-success propose-btn" data-id="${need.id}">Направить предложение</button>
                                                    `}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <nav>${Utils.renderPagination(State.needs.currentPage, totalPages, 'needs')}</nav>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header"><h3><i class="bi bi-basket3-fill me-2"></i>На предложение</h3></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light"><tr><th>Наименование</th><th>Кол-во</th><th>Срок поставки</th><th>Действие</th></tr></thead>
                                    <tbody>
                                        ${needs.filter(n => userProposals.includes(n.id)).map(need => `
                                            <tr>
                                                <td>${need.name}</td><td>${need.quantity} ${need.unit}</td><td>${need.deliveryDate}</td>
                                                <td><button class="btn btn-sm btn-danger remove-proposal-btn" data-id="${need.id}"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${userProposals.length > 0 ? `
                                <button class="btn btn-danger" id="clearProposalBtn"><i class="bi bi-x-circle me-2"></i>Очистить все</button>
                                <button class="btn btn-primary" id="submitProposalBtn"><i class="bi bi-send me-2"></i>Отправить в работу</button>
                            ` : '<p class="text-muted">Вы еще не добавили ни одной позиции.</p>'}
                        </div>
                    </div>
                `;

                // Event Listeners for supplier page
                const reRender = () => Views.renderSupplierNeeds();
                document.getElementById('typeFilter').addEventListener('change', e => { State.needs.filters.type = e.target.value; State.needs.currentPage = 1; reRender(); });
                document.getElementById('statusFilter').addEventListener('change', e => { State.needs.filters.status = e.target.value; State.needs.currentPage = 1; reRender(); });
                document.getElementById('search').addEventListener('input', e => { State.needs.filters.search = e.target.value; State.needs.currentPage = 1; reRender(); });
                
                appRoot.addEventListener('click', e => {
                    const target = e.target;
                    if (target.classList.contains('page-link') && target.dataset.stateKey === 'needs') {
                        e.preventDefault();
                        State.needs.currentPage = parseInt(target.dataset.page);
                        reRender();
                    }
                    if (target.closest('th[data-sort]')) {
                        const th = target.closest('th[data-sort]');
                        const column = th.dataset.sort;
                        if (State.needs.sort.column === column) {
                            State.needs.sort.direction = State.needs.sort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            State.needs.sort.column = column;
                            State.needs.sort.direction = 'asc';
                        }
                        reRender();
                    }

                    const needId = parseInt(target.dataset.id);
                    if (target.classList.contains('propose-btn') || target.classList.contains('undo-proposal-btn') || target.classList.contains('remove-proposal-btn')) {
                        let proposals = DB.get('proposals');
                        const existingIndex = proposals.findIndex(p => p.userId === currentUser.id && p.needId === needId);
                        if (existingIndex > -1) {
                            proposals.splice(existingIndex, 1);
                        } else {
                            proposals.push({ userId: currentUser.id, needId: needId });
                        }
                        DB.set('proposals', proposals);
                        reRender();
                    }

                    if (target.id === 'clearProposalBtn') {
                        let proposals = DB.get('proposals').filter(p => p.userId !== currentUser.id);
                        DB.set('proposals', proposals);
                        reRender();
                    }

                    if (target.id === 'submitProposalBtn') {
                        const userProposalIds = DB.get('proposals').filter(p => p.userId === currentUser.id).map(p => p.needId);
                        const proposalNeeds = DB.get('needs').filter(n => userProposalIds.includes(n.id));
                        
                        const emailBody = { message: "Отправлено письмо с таблицей позиций и инструкцией: 'Ответьте с ценами в течение 3 дней'", data: proposalNeeds };
                        console.log(emailBody);
                        Utils.showModal('Предложение отправлено', 'Ваше предложение было успешно отправлено в медицинское учреждение.');

                        let inWork = DB.get('inWork') || [];
                        inWork.push({ userId: currentUser.id, needs: userProposalIds, date: new Date().toISOString() });
                        DB.set('inWork', inWork);

                        let proposals = DB.get('proposals').filter(p => p.userId !== currentUser.id);
                        DB.set('proposals', proposals);
                        reRender();
                    }
                });
            },

            // --- Admin Views ---
            admin: {
                renderLogin: () => {
                    Utils.renderBreadcrumbs([]);
                    const appRoot = document.getElementById('app-root');
                    appRoot.innerHTML = `
                        <div class="d-flex justify-content-center align-items-center" style="min-height: 60vh;">
                            <form id="adminLoginForm" class="form-signin card p-4 shadow-sm">
                                <h1 class="h3 mb-3 fw-normal text-center">Вход для администратора</h1>
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="adminLogin" placeholder="Логин" required value="admin">
                                    <label for="adminLogin">Логин</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="password" class="form-control" id="adminPassword" placeholder="Пароль" required value="admin123">
                                    <label for="adminPassword">Пароль</label>
                                </div>
                                <div id="login-error" class="alert alert-danger" style="display: none;"></div>
                                <button class="w-100 btn btn-lg btn-primary" type="submit">Войти</button>
                            </form>
                        </div>
                    `;

                    document.getElementById('adminLoginForm').addEventListener('submit', e => {
                        e.preventDefault();
                        const login = document.getElementById('adminLogin').value;
                        const pass = document.getElementById('adminPassword').value;
                        const adminCreds = DB.get('admin');
                        const errorDiv = document.getElementById('login-error');

                        if (login === adminCreds.login && pass === adminCreds.password) {
                            Auth.login('admin', 'mock-admin-jwt-token');
                            window.location.hash = '/admin';
                        } else {
                            errorDiv.textContent = 'Неверный логин или пароль.';
                            errorDiv.style.display = 'block';
                        }
                    });
                },

                renderDashboard: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель управления' }]);
                    const appRoot = document.getElementById('app-root');
                    const users = DB.get('users');
                    const needs = DB.get('needs');
                    const proposals = DB.get('proposals');
                    const log = DB.get('notificationLog');

                    appRoot.innerHTML = `
                        <div class="row">
                            <div class="col-lg-8 mb-4">
                                <div class="card widget shadow-sm">
                                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i>Последние действия</h5></div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            ${[...log].reverse().slice(0, 3).map(l => `
                                                <li class="list-group-item">
                                                    <small class="text-muted float-end">${Utils.formatDate(l.date)}</small>
                                                    <i class="bi bi-envelope me-2 text-primary"></i> Уведомление "<strong>${l.templateName}</strong>" отправлено <strong>${l.recipient}</strong>.
                                                </li>
                                            `).join('')}
                                            ${[...users].reverse().slice(0, 2).map(u => `
                                                <li class="list-group-item">
                                                    <i class="bi bi-person-plus-fill me-2 text-success"></i> Зарегистрирован новый поставщик: <a href="#/admin/users/edit/${u.id}">${u.login}</a>.
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 mb-4">
                                <div class="card widget shadow-sm">
                                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-bar-chart-line me-2"></i>Ключевые метрики</h5></div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                                            <span><i class="bi bi-people-fill me-2 text-primary"></i>Всего поставщиков</span>
                                            <span class="badge bg-primary rounded-pill fs-6">${users.length}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                                            <span><i class="bi bi-card-list me-2 text-info"></i>Активных потребностей</span>
                                            <span class="badge bg-info rounded-pill fs-6">${needs.length}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-check2-square me-2 text-success"></i>Уникальных предложений</span>
                                            <span class="badge bg-success rounded-pill fs-6">${[...new Set(proposals.map(p => p.userId))].length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                },

                renderNeedsList: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель управления', link: '#/admin/dashboard' }, { name: 'Потребности' }]);
                    State.loadListState('needs');
                    const appRoot = document.getElementById('app-root');
                    const needs = DB.get('needs');
                    
                    let filteredNeeds = needs.filter(need => {
                        const typeMatch = State.needs.filters.type ? need.type === State.needs.filters.type : true;
                        const statusMatch = State.needs.filters.status ? need.status === State.needs.filters.status : true;
                        const searchMatch = State.needs.filters.search ? (need.name.toLowerCase().includes(State.needs.filters.search.toLowerCase()) || need.code.toLowerCase().includes(State.needs.filters.search.toLowerCase())) : true;
                        const submittedByUserMatch = State.needs.filters.submitted_by_user_id ? DB.get('proposals').some(p => p.needId === need.id && p.userId === State.needs.filters.submitted_by_user_id) : true;
                        return typeMatch && statusMatch && searchMatch && submittedByUserMatch;
                    });

                    filteredNeeds = Utils.applySorting(filteredNeeds, State.needs.sort);
                    const totalPages = Math.ceil(filteredNeeds.length / State.needs.itemsPerPage);
                    const paginatedNeeds = filteredNeeds.slice((State.needs.currentPage - 1) * State.needs.itemsPerPage, State.needs.currentPage * State.needs.itemsPerPage);
                    const uniqueTypes = [...new Set(DB.get('needs').map(n => n.type))];
                    const uniqueStatuses = [...new Set(DB.get('needs').map(n => n.status))];
                    const savedViews = DB.get('savedViews').needs;

                    appRoot.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>Управление потребностями</h2>
                            <a href="#/admin/needs/new" class="btn btn-success"><i class="bi bi-plus-circle me-2"></i>Добавить потребность</a>
                        </div>
                        ${State.needs.filters.submitted_by_user_id ? `<div class="alert alert-info">Показаны предложения от пользователя ID: ${State.needs.filters.submitted_by_user_id}. <a href="#" id="clearUserFilter">Сбросить фильтр</a></div>` : ''}
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3 mb-3 align-items-center">
                                    <div class="col-md-2"><select class="form-select" id="typeFilter"><option value="">Все типы</option>${uniqueTypes.map(t => `<option value="${t}" ${State.needs.filters.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                                    <div class="col-md-2"><select class="form-select" id="statusFilter"><option value="">Все статусы</option>${uniqueStatuses.map(s => `<option value="${s}" ${State.needs.filters.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                                    <div class="col-md-3"><input type="text" class="form-control" id="search" placeholder="Поиск..." value="${State.needs.filters.search}"></div>
                                    <div class="col-md-5 d-flex justify-content-end">
                                        <div class="input-group w-auto">
                                            <select class="form-select" id="savedViewsSelect"><option value="">Сохраненные представления</option>${savedViews.map(v => `<option value="${v.name}">${v.name}</option>`).join('')}</select>
                                            <button class="btn btn-outline-secondary" id="saveViewBtn" title="Сохранить"><i class="bi bi-save"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th data-sort="type">Тип ${Utils.renderSortIcon('type', State.needs)}</th>
                                                <th data-sort="name">Наименование ${Utils.renderSortIcon('name', State.needs)}</th>
                                                <th data-sort="code">Код ${Utils.renderSortIcon('code', State.needs)}</th>
                                                <th data-sort="quantity">Кол-во ${Utils.renderSortIcon('quantity', State.needs)}</th>
                                                <th data-sort="deliveryDate">Срок ${Utils.renderSortIcon('deliveryDate', State.needs)}</th>
                                                <th data-sort="status">Статус ${Utils.renderSortIcon('status', State.needs)}</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${paginatedNeeds.map(n => `
                                                <tr>
                                                    <td>${n.type}</td><td>${n.name}</td><td>${n.code}</td><td>${n.quantity} ${n.unit}</td><td>${n.deliveryDate}</td><td>${n.status}</td>
                                                    <td>
                                                        <a href="#/admin/needs/edit/${n.id}" class="btn btn-sm btn-warning edit-need-btn" data-id="${n.id}"><i class="bi bi-pencil-fill"></i></a>
                                                        <button class="btn btn-sm btn-danger delete-need-btn" data-id="${n.id}"><i class="bi bi-trash-fill"></i></button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <nav>${Utils.renderPagination(State.needs.currentPage, totalPages, 'needs')}</nav>
                            </div>
                        </div>
                    `;
                    
                    // Event Listeners for needs list
                    const reRender = () => Views.admin.renderNeedsList();
                    document.getElementById('typeFilter').addEventListener('change', e => { State.needs.filters.type = e.target.value; State.needs.currentPage = 1; reRender(); });
                    document.getElementById('statusFilter').addEventListener('change', e => { State.needs.filters.status = e.target.value; State.needs.currentPage = 1; reRender(); });
                    document.getElementById('search').addEventListener('input', e => { State.needs.filters.search = e.target.value; State.needs.currentPage = 1; reRender(); });
                    
                    const clearUserFilterBtn = document.getElementById('clearUserFilter');
                    if (clearUserFilterBtn) {
                        clearUserFilterBtn.addEventListener('click', e => {
                            e.preventDefault();
                            State.resetListState('needs');
                            window.location.hash = '#/admin/needs';
                        });
                    }

                    appRoot.addEventListener('click', e => {
                        const target = e.target;
                        if (target.classList.contains('page-link') && target.dataset.stateKey === 'needs') {
                            e.preventDefault();
                            State.needs.currentPage = parseInt(target.dataset.page);
                            reRender();
                        }
                        if (target.closest('th[data-sort]')) {
                            const th = target.closest('th[data-sort]');
                            const column = th.dataset.sort;
                            if (State.needs.sort.column === column) {
                                State.needs.sort.direction = State.needs.sort.direction === 'asc' ? 'desc' : 'asc';
                            } else {
                                State.needs.sort.column = column;
                                State.needs.sort.direction = 'asc';
                            }
                            reRender();
                        }
                        if (target.closest('.edit-need-btn')) {
                            State.saveListState('needs');
                        }
                        if (target.closest('.delete-need-btn')) {
                            const needId = parseInt(target.closest('.delete-need-btn').dataset.id);
                            if (confirm('Вы уверены, что хотите удалить эту потребность?')) {
                                let needs = DB.get('needs').filter(n => n.id !== needId);
                                DB.set('needs', needs);
                                Utils.showToast('Потребность удалена');
                                reRender();
                            }
                        }
                    });
                },

                renderNeedForm: (needId = null) => {
                    const isEditing = needId !== null;
                    const needs = DB.get('needs');
                    const need = isEditing ? needs.find(n => n.id === needId) : {};

                    if (isEditing && !need) {
                        document.getElementById('app-root').innerHTML = `<div class="alert alert-danger">Потребность с ID ${needId} не найдена.</div>`;
                        return;
                    }

                    const title = isEditing ? `Редактирование: ${need.name}` : 'Новая потребность';
                    Utils.renderBreadcrumbs([{ name: 'Панель', link: '#/admin/dashboard' }, { name: 'Потребности', link: '#/admin/needs' }, { name: title }]);
                    
                    const appRoot = document.getElementById('app-root');
                    appRoot.innerHTML = `
                        <h2>${title}</h2>
                        <div class="card">
                            <div class="card-body">
                                <form id="needForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Тип товара</label><select name="type" class="form-select" required><option value="Медикаменты" ${isEditing && need.type === 'Медикаменты' ? 'selected' : ''}>Медикаменты</option><option value="Оборудование" ${isEditing && need.type === 'Оборудование' ? 'selected' : ''}>Оборудование</option><option value="Расходные материалы" ${isEditing && need.type === 'Расходные материалы' ? 'selected' : ''}>Расходные материалы</option></select></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Наименование</label><input type="text" name="name" class="form-control" value="${isEditing ? need.name : ''}" required></div>
                                    </div>
                                    <div class="mb-3"><label class="form-label">Характеристики</label><textarea name="description" class="form-control">${isEditing ? need.description : ''}</textarea></div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Код ОКПД2/КТРУ</label><input type="text" name="code" class="form-control" value="${isEditing ? need.code : ''}" required></div>
                                        <div class="col-md-3 mb-3"><label class="form-label">Ед. изм.</label><select name="unit" class="form-select"><option>шт</option><option>упаковка</option><option>флакон</option></select></div>
                                        <div class="col-md-3 mb-3"><label class="form-label">Количество</label><input type="number" name="quantity" class="form-control" value="${isEditing ? need.quantity : ''}" required></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Срок поставки</label><input type="date" name="deliveryDate" class="form-control" value="${isEditing ? need.deliveryDate : ''}" required></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Статус</label><select name="status" class="form-select" required><option value="Запрос КП" ${isEditing && need.status === 'Запрос КП' ? 'selected' : ''}>Запрос КП</option><option value="Малая закупка" ${isEditing && need.status === 'Малая закупка' ? 'selected' : ''}>Малая закупка</option><option value="Аукцион" ${isEditing && need.status === 'Аукцион' ? 'selected' : ''}>Аукцион</option></select></div>
                                    </div>
                                    <a href="#/admin/needs" class="btn btn-secondary">Назад к списку</a>
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </form>
                            </div>
                        </div>
                    `;

                    document.getElementById('needForm').addEventListener('submit', e => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const needData = Object.fromEntries(formData.entries());
                        needData.quantity = parseInt(needData.quantity);
                        
                        let needs = DB.get('needs');
                        if (isEditing) {
                            const oldNeed = needs.find(n => n.id === needId);
                            if (oldNeed.status !== needData.status) {
                                App.triggerEvent('need_status_changed', { need: { ...need, ...needData } });
                            }
                            needs = needs.map(n => n.id === needId ? { ...n, ...needData } : n);
                        } else {
                            needData.id = DB.getNextId('needs');
                            needs.push(needData);
                        }
                        DB.set('needs', needs);
                        Utils.showToast(`Потребность успешно ${isEditing ? 'обновлена' : 'создана'}`);
                        window.location.hash = '#/admin/needs';
                    });
                },

                renderUsersList: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель управления', link: '#/admin/dashboard' }, { name: 'Пользователи' }]);
                    State.loadListState('users');
                    const appRoot = document.getElementById('app-root');
                    const users = DB.get('users');
                    const proposals = DB.get('proposals');

                    let filteredUsers = users.filter(user => {
                        const statusMatch = State.users.filters.status ? user.status === State.users.filters.status : true;
                        const searchMatch = State.users.filters.search ? (user.login.toLowerCase().includes(State.users.filters.search.toLowerCase()) || user.email.toLowerCase().includes(State.users.filters.search.toLowerCase())) : true;
                        return statusMatch && searchMatch;
                    });

                    filteredUsers = Utils.applySorting(filteredUsers, State.users.sort);
                    const totalPages = Math.ceil(filteredUsers.length / State.users.itemsPerPage);
                    const paginatedUsers = filteredUsers.slice((State.users.currentPage - 1) * State.users.itemsPerPage, State.users.currentPage * State.users.itemsPerPage);
                    const savedViews = DB.get('savedViews').users;

                    appRoot.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3"><h2>Управление пользователями</h2></div>
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3 mb-3 align-items-center">
                                    <div class="col-md-3"><select class="form-select" id="userStatusFilter"><option value="">Все статусы</option><option value="active" ${State.users.filters.status === 'active' ? 'selected' : ''}>Активен</option><option value="blocked" ${State.users.filters.status === 'blocked' ? 'selected' : ''}>Заблокирован</option></select></div>
                                    <div class="col-md-4"><input type="text" class="form-control" id="userSearch" placeholder="Поиск по логину или email..." value="${State.users.filters.search}"></div>
                                    <div class="col-md-5 d-flex justify-content-end">
                                        <div class="input-group w-auto">
                                            <select class="form-select" id="savedViewsSelect"><option value="">Сохраненные представления</option>${savedViews.map(v => `<option value="${v.name}">${v.name}</option>`).join('')}</select>
                                            <button class="btn btn-outline-secondary" id="saveViewBtn" title="Сохранить"><i class="bi bi-save"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th data-sort="login">Логин ${Utils.renderSortIcon('login', State.users)}</th>
                                                <th data-sort="email">Email ${Utils.renderSortIcon('email', State.users)}</th>
                                                <th>Предложений</th>
                                                <th data-sort="status">Статус ${Utils.renderSortIcon('status', State.users)}</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${paginatedUsers.map(u => {
                                                const userProposalCount = proposals.filter(p => p.userId === u.id).length;
                                                return `
                                                <tr>
                                                    <td>${u.login}</td><td>${u.email}</td>
                                                    <td><a href="#/admin/needs?submitted_by_user_id=${u.id}" class="btn btn-sm btn-outline-info" title="Показать предложения этого пользователя">${userProposalCount}</a></td>
                                                    <td><span class="badge bg-${u.status === 'active' ? 'success' : 'danger'}">${u.status === 'active' ? 'Активен' : 'Заблокирован'}</span></td>
                                                    <td>
                                                        <a href="#/admin/users/edit/${u.id}" class="btn btn-sm btn-warning edit-user-btn" data-id="${u.id}"><i class="bi bi-pencil-fill"></i></a>
                                                        <button class="btn btn-sm btn-secondary toggle-block-btn" data-id="${u.id}"><i class="bi ${u.status === 'active' ? 'bi-lock-fill' : 'bi-unlock-fill'}"></i></button>
                                                        <button class="btn btn-sm btn-danger delete-user-btn" data-id="${u.id}"><i class="bi bi-trash-fill"></i></button>
                                                    </td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <nav>${Utils.renderPagination(State.users.currentPage, totalPages, 'users')}</nav>
                            </div>
                        </div>
                    `;
                    
                    const reRender = () => Views.admin.renderUsersList();
                    document.getElementById('userStatusFilter').addEventListener('change', e => { State.users.filters.status = e.target.value; State.users.currentPage = 1; reRender(); });
                    document.getElementById('userSearch').addEventListener('input', e => { State.users.filters.search = e.target.value; State.users.currentPage = 1; reRender(); });
                    
                    appRoot.addEventListener('click', e => {
                        const target = e.target;
                        if (target.classList.contains('page-link') && target.dataset.stateKey === 'users') {
                            e.preventDefault();
                            State.users.currentPage = parseInt(target.dataset.page);
                            reRender();
                        }
                        if (target.closest('th[data-sort]')) {
                            const th = target.closest('th[data-sort]');
                            const column = th.dataset.sort;
                            if (State.users.sort.column === column) {
                                State.users.sort.direction = State.users.sort.direction === 'asc' ? 'desc' : 'asc';
                            } else {
                                State.users.sort.column = column;
                                State.users.sort.direction = 'asc';
                            }
                            reRender();
                        }
                        
                        const button = target.closest('button, a');
                        if (!button) return;
                        
                        if (button.classList.contains('edit-user-btn')) {
                            State.saveListState('users');
                        }
                        if (button.classList.contains('toggle-block-btn')) {
                            const userId = parseInt(button.dataset.id);
                            let users = DB.get('users');
                            users = users.map(u => u.id === userId ? { ...u, status: u.status === 'active' ? 'blocked' : 'active' } : u);
                            DB.set('users', users);
                            Utils.showToast('Статус пользователя изменен');
                            reRender();
                        }
                        if (button.classList.contains('delete-user-btn')) {
                            const userId = parseInt(button.dataset.id);
                            if (confirm('Вы уверены? Это действие необратимо.')) {
                                let users = DB.get('users').filter(u => u.id !== userId);
                                DB.set('users', users);
                                Utils.showToast('Пользователь удален', 'danger');
                                reRender();
                            }
                        }
                    });
                },

                renderUserForm: (userId) => {
                    const user = DB.get('users').find(u => u.id === userId);
                    if (!user) {
                        document.getElementById('app-root').innerHTML = `<div class="alert alert-danger">Пользователь с ID ${userId} не найден.</div>`;
                        return;
                    }
                    Utils.renderBreadcrumbs([{ name: 'Панель', link: '#/admin/dashboard' }, { name: 'Пользователи', link: '#/admin/users' }, { name: `Редактирование: ${user.login}` }]);
                    
                    const appRoot = document.getElementById('app-root');
                    appRoot.innerHTML = `
                        <h2>Редактирование пользователя: ${user.login}</h2>
                        <div class="card">
                            <div class="card-body">
                                <form id="userEditForm">
                                    <div class="mb-3"><label class="form-label">Логин</label><input type="text" id="editLogin" class="form-control" value="${user.login}"></div>
                                    <div class="mb-3"><label class="form-label">Email</label><input type="email" id="editEmail" class="form-control" value="${user.email}"></div>
                                    <a href="#/admin/users" class="btn btn-secondary">Назад к списку</a>
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </form>
                            </div>
                        </div>
                    `;

                    document.getElementById('userEditForm').addEventListener('submit', e => {
                        e.preventDefault();
                        const newLogin = document.getElementById('editLogin').value;
                        const newEmail = document.getElementById('editEmail').value;
                        let users = DB.get('users');
                        users = users.map(u => u.id === userId ? { ...u, login: newLogin, email: newEmail } : u);
                        DB.set('users', users);
                        Utils.showToast('Данные пользователя обновлены');
                        window.location.hash = '#/admin/users';
                    });
                },

                renderNotificationTemplates: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель', link: '#/admin/dashboard' }, { name: 'Уведомления' }, { name: 'Шаблоны' }]);
                    const appRoot = document.getElementById('app-root');
                    const templates = DB.get('notificationTemplates');
                    
                    appRoot.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2>Шаблоны уведомлений</h2>
                            <button class="btn btn-success" id="addTemplateBtn"><i class="bi bi-plus-circle me-2"></i>Создать шаблон</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead><tr><th>Название</th><th>Событие-триггер</th><th>Тема письма</th><th>Действия</th></tr></thead>
                                        <tbody>
                                            ${templates.map(t => `
                                                <tr>
                                                    <td>${t.name}</td>
                                                    <td><span class="badge bg-secondary">${t.event}</span></td>
                                                    <td>${t.subject}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-warning edit-template-btn" data-id="${t.id}"><i class="bi bi-pencil-fill"></i></button>
                                                        <button class="btn btn-sm btn-danger delete-template-btn" data-id="${t.id}"><i class="bi bi-trash-fill"></i></button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;

                    const renderTemplateModal = (template = null) => {
                        const isEditing = template !== null;
                        const title = isEditing ? 'Редактировать шаблон' : 'Создать шаблон';
                        const modalBody = `
                            <form id="templateForm">
                                <div class="mb-3"><label class="form-label">Название шаблона</label><input type="text" name="name" class="form-control" value="${isEditing ? template.name : ''}" required></div>
                                <div class="mb-3"><label class="form-label">Событие-триггер</label><select name="event" class="form-select"><option value="manual">Ручная отправка</option><option value="user_registered">Регистрация пользователя</option><option value="need_status_changed">Смена статуса потребности</option></select></div>
                                <div class="mb-3"><label class="form-label">Тема письма</label><input type="text" name="subject" class="form-control" value="${isEditing ? template.subject : ''}" required></div>
                                <div class="mb-3"><label class="form-label">Тело письма</label><textarea name="body" class="form-control" rows="6">${isEditing ? template.body : ''}</textarea><small class="form-text text-muted">Доступные переменные: {{user.login}}, {{need.name}}, {{need.code}}, {{need.status}}</small></div>
                            </form>
                        `;
                        const modalFooter = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary" id="saveTemplateBtn">Сохранить</button>`;
                        const modal = Utils.showModal(title, modalBody, modalFooter, 'modal-lg');

                        document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                            const form = document.getElementById('templateForm');
                            const formData = new FormData(form);
                            const templateData = Object.fromEntries(formData.entries());
                            let templates = DB.get('notificationTemplates');
                            if (isEditing) {
                                templates = templates.map(t => t.id === template.id ? { ...t, ...templateData } : t);
                            } else {
                                templateData.id = DB.getNextId('notificationTemplates');
                                templates.push(templateData);
                            }
                            DB.set('notificationTemplates', templates);
                            modal.hide();
                            Utils.showToast('Шаблон сохранен');
                            Views.admin.renderNotificationTemplates();
                        });
                    };

                    document.getElementById('addTemplateBtn').addEventListener('click', () => renderTemplateModal());
                    appRoot.addEventListener('click', e => {
                        const button = e.target.closest('button');
                        if (!button) return;
                        const templateId = parseInt(button.dataset.id);
                        if (button.classList.contains('edit-template-btn')) {
                            const template = DB.get('notificationTemplates').find(t => t.id === templateId);
                            renderTemplateModal(template);
                        }
                        if (button.classList.contains('delete-template-btn')) {
                            if (confirm('Удалить этот шаблон?')) {
                                let templates = DB.get('notificationTemplates').filter(t => t.id !== templateId);
                                DB.set('notificationTemplates', templates);
                                Utils.showToast('Шаблон удален', 'danger');
                                Views.admin.renderNotificationTemplates();
                            }
                        }
                    });
                },

                renderNotificationLog: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель', link: '#/admin/dashboard' }, { name: 'Уведомления' }, { name: 'Лог отправки' }]);
                    const appRoot = document.getElementById('app-root');
                    const log = [...DB.get('notificationLog')].reverse();
                    appRoot.innerHTML = `
                        <h2>Лог отправки уведомлений</h2>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead><tr><th>Дата</th><th>Получатель</th><th>Шаблон</th><th>Тема</th></tr></thead>
                                        <tbody>
                                            ${log.map(l => `
                                                <tr>
                                                    <td>${Utils.formatDate(l.date)}</td>
                                                    <td>${l.recipient}</td>
                                                    <td>${l.templateName}</td>
                                                    <td>${l.subject}</td>
                                                </tr>
                                            `).join('') || '<tr><td colspan="4" class="text-center text-muted">Лог пуст.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                },

                renderStatistics: () => {
                    Utils.renderBreadcrumbs([{ name: 'Панель', link: '#/admin/dashboard' }, { name: 'Статистика' }]);
                    const appRoot = document.getElementById('app-root');
                    const stats = { users: DB.get('users').length, views: 50, proposals: 20 };
                    const needs = DB.get('needs');
                    const statusCounts = needs.reduce((acc, need) => {
                        acc[need.status] = (acc[need.status] || 0) + 1;
                        return acc;
                    }, {});

                    appRoot.innerHTML = `
                        <h2>Статистика</h2>
                        <div class="row">
                            <div class="col-md-4"><div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title">Зарегистрировано поставщиков</h5><p class="card-text fs-2">${stats.users}</p></div></div></div>
                            <div class="col-md-4"><div class="card text-white bg-info mb-3"><div class="card-body"><h5 class="card-title">Просмотры позиций</h5><p class="card-text fs-2">${stats.views}</p></div></div></div>
                            <div class="col-md-4"><div class="card text-white bg-success mb-3"><div class="card-body"><h5 class="card-title">Отправлено предложений</h5><p class="card-text fs-2">${stats.proposals}</p></div></div></div>
                        </div>
                        <div class="card">
                            <div class="card-header">Количество потребностей по статусам</div>
                            <div class="card-body"><canvas id="statusChart" style="max-height: 400px;"></canvas></div>
                        </div>
                    `;

                    const ctx = document.getElementById('statusChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(statusCounts),
                            datasets: [{
                                label: 'Количество потребностей',
                                data: Object.values(statusCounts),
                                backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)'],
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        };

        // ========================================================================
        // 6. ROUTER & APP INITIALIZATION
        // ========================================================================
        const App = {
            triggerEvent: (eventName, data) => {
                const template = DB.get('notificationTemplates').find(t => t.event === eventName);
                if (!template) return;

                let subject = template.subject;
                let body = template.body;
                let recipient = 'N/A';

                if (eventName === 'user_registered') {
                    subject = subject.replace(/{{user.login}}/g, data.user.login);
                    body = body.replace(/{{user.login}}/g, data.user.login);
                    recipient = data.user.email;
                }
                if (eventName === 'need_status_changed') {
                    subject = subject.replace(/{{need.name}}/g, data.need.name);
                    body = body.replace(/{{need.name}}/g, data.need.name).replace(/{{need.code}}/g, data.need.code).replace(/{{need.status}}/g, data.need.status);
                    recipient = 'Всем заинтересованным'; // Имитация
                }

                const logEntry = { id: DB.getNextId('notificationLog'), date: new Date().toISOString(), recipient, templateName: template.name, subject, body };
                const log = DB.get('notificationLog');
                log.push(logEntry);
                DB.set('notificationLog', log);

                console.log(`--- ИМИТАЦИЯ EMAIL --- \nКому: ${recipient}\nТема: ${subject}\nТело:\n${body}\n--------------------`);
            },

            route: () => {
                const { pathParts, queryParams } = Utils.parseHash();
                Views.renderHeader();
                
                const root = pathParts[0] || '';
                const page = pathParts[1] || '';
                const action = pathParts[2] || '';
                const id = pathParts[3] ? parseInt(pathParts[3]) : null;

                if (root === 'admin') {
                    if (!Auth.isLoggedIn('admin')) { window.location.hash = '/admin-login'; return; }
                    
                    switch(page) {
                        case 'dashboard': Views.admin.renderDashboard(); break;
                        case 'needs':
                            if (action === 'edit') Views.admin.renderNeedForm(id);
                            else if (action === 'new') Views.admin.renderNeedForm();
                            else {
                                const userId = queryParams.get('submitted_by_user_id');
                                if (userId) {
                                    State.resetListState('needs');
                                    State.needs.filters.submitted_by_user_id = parseInt(userId);
                                }
                                Views.admin.renderNeedsList();
                            }
                            break;
                        case 'users':
                            if (action === 'edit') Views.admin.renderUserForm(id);
                            else Views.admin.renderUsersList();
                            break;
                        case 'statistics': Views.admin.renderStatistics(); break;
                        case 'templates': Views.admin.renderNotificationTemplates(); break;
                        case 'log': Views.admin.renderNotificationLog(); break;
                        default: window.location.hash = '/admin/dashboard';
                    }

                } else if (root === 'admin-login') {
                    Views.admin.renderLogin();
                } else {
                    if (Auth.isLoggedIn('supplier')) {
                        Views.renderSupplierNeeds();
                    } else {
                        Views.renderSupplierRegister();
                    }
                }
            },
            init: () => {
                DB.init();
                window.addEventListener('hashchange', App.route);
                App.route();
            }
        };

        App.init();
    });
    </script>

</body>
</html>